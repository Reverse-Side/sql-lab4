name: FastAPI + Postgres CI

on:
  push:
    branches: [ "main", "dev" ]
  pull_request:
    branches: [ "main", "dev" ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set environment variables
        run: |
          echo "POSTGRES_USER=postgres" >> $GITHUB_ENV
          echo "POSTGRES_PASSWORD=postgres" >> $GITHUB_ENV
          echo "POSTGRES_DB=app_db" >> $GITHUB_ENV
          echo "DATABASE_URI=postgresql+asyncpg://postgres:postgres@db:5432/app_db" >> $GITHUB_ENV

      - name: Install Docker Compose
        run: |
          sudo apt-get update -y
          sudo apt-get install -y docker-compose

      - name: Build containers
        run: docker compose build

      - name: Initialize JWT keys and DB
        run: |
          chmod +x init_jwt_key.sh init_db.sh
          ./init_jwt_key.sh
          ./init_db.sh

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run tests
  
        env:
          DATABASE_URI: "sqlite+aiosqlite:///:memory:"
        run: pytest -v --disable-warnings

         