name: Report test results to Telegram

on:
  # –ù–∞–∑–≤–∞ —Ç—É—Ç –º–∞—î –¢–û–ß–ù–û –∑–±—ñ–≥–∞—Ç–∏—Å—è –∑ –Ω–∞–∑–≤–æ—é –≤ YAML-—Ñ–∞–π–ª—ñ –ø–µ—Ä—à–æ–≥–æ –≤–æ—Ä–∫—Ñ–ª–æ—É
  workflow_run:
    workflows: ["FastAPI + Postgres CI"] 
    types:
      - completed

jobs:
  notify:
    # –í–∞–∂–ª–∏–≤–æ: –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ permissions, —â–æ–± –¥–æ–∑–≤–æ–ª–∏—Ç–∏ —á–∏—Ç–∞–Ω–Ω—è/–∑–∞–ø—É—Å–∫
    # –Ø–∫—â–æ –≤–æ—Ä–∫—Ñ–ª–æ—É –Ω–µ –∑–∞–ø—É—Å–∫–∞—î—Ç—å—Å—è, —Å–ø—Ä–æ–±—É–π—Ç–µ –¥–æ–¥–∞—Ç–∏ —Ü—ñ –¥–æ–∑–≤–æ–ª–∏.
    permissions:
      contents: read
      actions: read
      
    runs-on: ubuntu-latest
    steps:
      - name: Send Telegram report
        # –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –≤—Å—ñ –∑–º—ñ–Ω–Ω—ñ –æ—Ç–æ—á–µ–Ω–Ω—è –¥–ª—è –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –≤ bash
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          STATUS: ${{ github.event.workflow_run.conclusion }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.event.workflow_run.head_branch }}
          # –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ 'head_commit' –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–µ—Ç–∞–ª–µ–π –∫–æ–º—ñ—Ç—É
          COMMIT_MSG: ${{ github.event.workflow_run.head_commit.message }}
          COMMIT_AUTHOR: ${{ github.event.workflow_run.head_commit.author.name }}
          RUN_URL: ${{ github.event.workflow_run.html_url }}
          
        run: |
          # –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ —ñ–∫–æ–Ω–∫—É –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ –¥–æ —Å—Ç–∞—Ç—É—Å—É
          case "$STATUS" in
              success) ICON="‚úÖ";;
              failure) ICON="‚ùå";;
              cancelled) ICON="‚ö™";;
              *) ICON="‚ùì";;
          esac

          # –ï–∫—Ä–∞–Ω—É—î–º–æ —Å–∏–º–≤–æ–ª–∏ Markdown —É –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—ñ –∫–æ–º—ñ—Ç—É, —â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ –∑–±–æ—é
          # –¶–µ –∫—Ä–∏—Ç–∏—á–Ω–æ, –æ—Å–∫—ñ–ª—å–∫–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –º–æ–∂–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ * –∞–±–æ _ —É –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—ñ
          ESCAPED_MSG=$(echo "${COMMIT_MSG}" | sed 's/[*_\[\]()~`>#\+\-=\{\}.!]/\\&/g')

          # –§–æ—Ä–º—É—î–º–æ —Ç–µ–∫—Å—Ç –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
          # –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ heredoc (EOF) –¥–ª—è –±–∞–≥–∞—Ç–æ—Ä—è–¥–∫–æ–≤–æ–≥–æ —Ç–µ–∫—Å—Ç—É
          # —Ç–∞ MarkdownV2 (–±–æ Markdown –∑–∞—Å—Ç–∞—Ä—ñ–≤)
          TEXT=$(cat <<EOF
          üì¶ *${REPO}*
          üåø –ì—ñ–ª–∫–∞: \`${BRANCH}\`
          üßë‚Äçüíª –ê–≤—Ç–æ—Ä: *${COMMIT_AUTHOR}*
          üí¨ –ö–æ–º—ñ—Ç: \`${ESCAPED_MSG}\`
          üß™ –†–µ–∑—É–ª—å—Ç–∞—Ç: ${ICON} *${STATUS}*
          üîó [–í—ñ–¥–∫—Ä–∏—Ç–∏ Workflow](${RUN_URL})
          EOF
          )
          
          # –ù–∞–¥—Å–∏–ª–∞—î–º–æ –∑–∞–ø–∏—Ç –¥–æ Telegram
          # –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ -G —Ç–∞ --data-urlencode –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –∫–æ–¥—É–≤–∞–Ω–Ω—è —Ç–µ–∫—Å—Ç—É
          # —Ç–∞ –≤–∫–∞–∑—É—î–º–æ parse_mode=MarkdownV2
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
              -G \
              --data-urlencode "chat_id=${TELEGRAM_CHAT_ID}" \
              --data-urlencode "parse_mode=MarkdownV2" \
              --data-urlencode "text=${TEXT}"